# Name: malware-jail
# Website: https://github.com/HynekPetrak/malware-jail
# Description: Nodejs sandbox for semi-automatic JavaScript malware analysis
# Category: Examine browser malware: JavaScript
# Author: Hynek Petrak
# License: https://github.com/HynekPetrak/malware-jail/blob/master/LICENSE
# Notes: jailme

include:
  - remnux.packages.git
  - remnux.packages.npm
  - remnux.packages.nodejs

remnux-tools-malware-jail-source:
  git.cloned:
    - name: https://github.com/hynekpetrak/malware-jail.git
    - target: /usr/local/malware-jail
    - user: root
    - branch: master
    - require:
      - sls: remnux.packages.git

remnux-tools-malware-jail-remove-malware:
  cmd.run:
    - name: rm -rf malware
    - cwd: /usr/local/malware-jail
    - watch:
      - git: remnux-tools-malware-jail-source

remnux-tools-malware-jail-install:
  cmd.run:
    - name: npm install
    - cwd: /usr/local/malware-jail
    - require:
      - sls: remnux.packages.npm
      - sls: remnux.packages.nodejs
    - watch:
      - cmd: remnux-tools-malware-jail-remove-malware

remnux-tools-malware-jail-wrapper:
  file.managed:
    - name: /usr/local/bin/jailme
    - replace: False
    - mode: 755
    - contents:
      - '#!/bin/bash'
      - node /usr/local/malware-jail/jailme.js ${*}
    - require:
      - git: remnux-tools-malware-jail-source
    - watch:
      - cmd: remnux-tools-malware-jail-install

remnux-tools-malware-jail-config:
  file.replace:
    - name: /usr/local/malware-jail/config.json
    - pattern: '"env/'
    - repl: '"/usr/local/malware-jail/env/'
    - prepend_if_not_found: False
    - require:
      - git: remnux-tools-malware-jail-source
    - watch:
      - file: remnux-tools-malware-jail-wrapper

remnux-tools-malware-jail-output:
  file.replace:
    - name: /usr/local/malware-jail/config.json
    - pattern: '"output/'
    - repl: '"/usr/local/malware-jail/output/'
    - prepend_if_not_found: False
    - require:
      - git: remnux-tools-malware-jail-source
    - watch:
      - file: remnux-tools-malware-jail-config

remnux-tools-malware-jail-sandbox:
  file.replace:
    - name: /usr/local/malware-jail/config.json
    - pattern: '"sandbox_dump'
    - repl: '"/usr/local/malware-jail/sandbox_dump'
    - prepend_if_not_found: False
    - require:
      - git: remnux-tools-malware-jail-source
    - watch:
      - file: remnux-tools-malware-jail-output
